<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Datos de Mortalidad de la Comunidad Valenciana</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-zinc-100 font-sans px-20" onload="bgTasks()">
    
    <h1 class="text-3xl text-center font-bold text-gray-800 my-12">Datos de Mortalidad de la Comunidad Valenciana</h1>

    
    
    <div class="grid grid-cols-2 gap-4">
        <div class="space-y-20">    
            <div class="text-sm  flex flex-row space-x-4 ">
                <button class="bg-emerald-600 p-1 rounded-lg font-semibold text-white drop-shadow-xl">AÑO</button>                
                <button class="bg-emerald-600 p-1 rounded-lg font-semibold text-white drop-shadow-xl">PROVINCIA</button>
                <button class="bg-emerald-600 p-1 rounded-lg font-semibold text-white drop-shadow-xl">MUNICIPIO</button>
                <button class="bg-emerald-600 p-1 rounded-lg font-semibold text-white drop-shadow-xl">CAUSA DE FALLECIMIENTO</button>
                <button class="bg-emerald-600 p-1 rounded-lg font-semibold text-white drop-shadow-xl">GÉNERO</button>
                <button class="bg-emerald-600 p-1 rounded-lg font-semibold text-white drop-shadow-xl">EDAD</button>
            </div>

            <button class="bg-blue-600 p-1 rounded-lg font-semibold text-white drop-shadow-xl" onclick="search()">Search</button>

            <div id="circles-area" class="flex flex-row" hidden>
                <div>
                    <canvas id="c0" width="150" height="150">
                        Your browser does not support the HTML5 canvas tag.
                    </canvas>
                    <p id="e0" class="text-center text-gray-800 font-semibold"></p>
                </div>
                <div>
                    <canvas id="c1" width="150" height="150">
                        Your browser does not support the HTML5 canvas tag.
                    </canvas>
                    <p id="e1" class="text-center text-gray-800 font-semibold"></p>
                </div>
                <div>
                    <canvas id="c2" width="150" height="150">
                        Your browser does not support the HTML5 canvas tag.
                    </canvas>
                    <p id="e2" class="text-center text-gray-800 font-semibold"></p>
                </div>
                <div>
                    <canvas id="c3" width="150" height="150">
                        Your browser does not support the HTML5 canvas tag.
                    </canvas>
                    <p id="e3" class="text-center text-gray-800 font-semibold"></p>
                </div>
                <div>
                    <canvas id="c4" width="150" height="150">
                        Your browser does not support the HTML5 canvas tag.
                    </canvas>
                    <p id="e4" class="text-center text-gray-800 font-semibold"></p>
                </div>
            </div>
            <div id="information-area" hidden>
                <h2 class="text-2xl text-gray-800 font-bold">Información:</h2>
                <div class="flex flex-col space-y-1">                
                    <p id="s0" class="text-lg text-gray-800 "></p>
                    <p id="s1" class="text-lg text-gray-800 "></p>
                    <p id="s2" class="text-lg text-gray-800 "></p>
                    <p id="s3" class="text-lg text-gray-800 "></p>
                    <p id="s4" class="text-lg text-gray-800 "></p>
                    <p id="s5" class="text-lg text-gray-800 "></p>
                </div>
            </div>
        </div>
        <div id="map-area" class="space-y-2" hidden>
            <div class="flex flex-row place-content-center text-emerald-600 space-x-2">
                <div class="w-5"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="location-dot" class="svg-inline--fa fa-location-dot" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M168.3 499.2C116.1 435 0 279.4 0 192C0 85.96 85.96 0 192 0C298 0 384 85.96 384 192C384 279.4 267 435 215.7 499.2C203.4 514.5 180.6 514.5 168.3 499.2H168.3zM192 256C227.3 256 256 227.3 256 192C256 156.7 227.3 128 192 128C156.7 128 128 156.7 128 192C128 227.3 156.7 256 192 256z"></path></svg></div>
                <h2 id="m1" class="text-2xl font-semibold">Alcoy</h2>                
            </div>
            
            <iframe class="w-full h-full drop-shadow-xl"  id="gmap_canvas" src="https://maps.google.com/maps?hl=es&q=Alcoy&t=&z=7&ie=UTF8&iwloc=&output=embed" frameborder="0" scrolling="no" marginheight="0" marginwidth="0">                            
            </iframe>
        </div>
    </div>

    <script>

        // Global variables
        var year = '2016';
        var province = 'Valencia';
        var municipality = 'Gandía';
        var cause_of_death = 'Septicemia';
        var genre = 'Hombre';
        var age = '>50';

        // onload
        function bgTasks() {

            // indexeddb
            loadDB()

            // load bubbles
            //loadBubbles()
        }

        function loadDB() {

            var db;

            if (!window.indexedDB) {
                console.log("Your browser doesn't support a stable version of IndexedDB. Such and such feature will not be available.");
            }

            var request = window.indexedDB.open("Database", 1);

            request.onerror = function(event) {
                console.error("Database error: " + event.target.errorCode);
            };
            request.onsuccess = function(event) {
                db = event.target.result;
            };
              
        }

        function loadBubbles(){

            for (let i = 0; i < 5; i++) {            
                var c = document.getElementById("c" + i.toString());
                var ctx = c.getContext("2d");
                ctx.beginPath();
                if (i == 0) {
                    ctx.arc(75, 75, 70, 0, 2 * Math.PI);
                } else {
                    ctx.arc(75, 75, 70 / i, 0, 2 * Math.PI);
                }
                ctx.stroke();
            }
        }


        function redrawCircles() {

            // Máx radio de las burbujas
            max = 70;

            // Devuelve el top5 enfermedades. TODO: Aplicar criterios
            top5 = getTop5CauseOfDeath();

            //console.log(top5);

            // Calcula el total de muertes de las top5 enfermedades
            total = 0;
            for (let i = 0; i < 5; i++) {
                total += top5[i]["Total"];
            }
            
            // Guarda el porcentaje más alto
            max_porcentaje = (top5[0]["Total"] * 100 / total) / 100


            //console.log("Total: " + total, " Máx Porc: " + max_porcentaje);

            for (let i = 0; i < 5; i++) {

                // Calcula el porcentaje relativo con respecto al total
                porcentaje = (top5[i]["Total"] * 100 / total) / 100

                factor = (porcentaje * 1 / max_porcentaje)

                //console.log("Porcentaje: " + porcentaje, " Factor: " + factor)

                var c = document.getElementById("c" + i.toString());
                var ctx = c.getContext("2d");
                ctx.clearRect(0, 0, c.width, c.height);
                ctx.beginPath();
                ctx.arc(75, 75, max * factor, 0, 2 * Math.PI);
                ctx.stroke();                
            }


            // Escribir top5 enfermedades
            for (let i = 0; i < 5; i++) {
                document.getElementById("e" + i).innerHTML = top5[i]["Disease"];            
            }

        }


        function rewriteSentences() {
            

            // s0
            var totalDeaths = getTotalDeaths();

            document.getElementById("s0").innerHTML = `En ${municipality} hubo un total de ${totalDeaths} fallecimientos en el año ${year}.`;


            // s1            
            document.getElementById("s1").innerHTML = `La causa de fallecimiento más común en el año ${year} en el municipio de ${municipality} es ${cause_of_death}.`;


            // s2
            var porcentajeS2 = 1 /* TODO: Crear función que calcule esto */

            document.getElementById("s2").innerHTML = `${porcentajeS2} de cada 100 fallecimientos de ${genre == 'Hombre' ? genre + 's' : genre +'es'} mayores de ${age} años en ${municipality} es debido a ${cause_of_death}.`;


            // s3
            var porcentajeS3 = '2' /* TODO: Crear función que calcule esto */

            document.getElementById("s3").innerHTML = `${municipality} representa un ${porcentajeS3}% del total de fallecimientos de la Comunidad Valenciana.`;


            // s4
            var rankingMunicipality = '3' /* TODO: Crear función que calcule esto */
            var rankingRegion = '17' /* TODO: Crear función que calcule esto */

            document.getElementById("s4").innerHTML = `${municipality} es la ${rankingMunicipality}º población más grande de la provincia de ${province} y la ${rankingRegion}º de la Comunidad Valenciana.`;


            // s5
            var porcentajeS5 = '60' /* TODO: Crear función que calcule esto */

            document.getElementById("s5").innerHTML = `El ${porcentajeS5}% de los fallecimientos de ${cause_of_death} fueron ${genre == 'Hombre' ? genre + 's' : genre +'es'}.`;
        }

        function redrawMap() {
            // m1
            document.getElementById("m1").innerHTML = `${municipality}`;

            var ref = document.getElementById("gmap_canvas");    
            ref.src = `https://maps.google.com/maps?hl=es&q=${municipality}&t=&z=7&ie=UTF8&iwloc=&output=embed`;

        }

        function search() {

            document.getElementById("map-area").hidden = false;
            document.getElementById("circles-area").hidden = false;
            document.getElementById("information-area").hidden = false;
            
            redrawCircles(); 
            rewriteSentences(); 
            redrawMap();
        }

        // "API"

        function getTotalDeaths() {
            // year, province, municipality, cause_of_death, genre, age


            return '250';
        }

        function getMostCommonCauseOfDeath(year, province, municipality, genre, age) {

            // return string
        }

        function getTop5CauseOfDeath(year, province, municipality, genre, age) {

            var top5 = [
                { 
                    Disease: "Septicemia",
                    Total: 50,
                },
                { 
                    Disease: "Hepatitis Viral",
                    Total: 5,
                },
                { 
                    Disease: "Tumor Estomago",
                    Total: 5,
                },
                { 
                    Disease: "Tumor Recto",
                    Total: 30,
                },
                { 
                    Disease: "Tumor Pulmón",
                    Total: 1,
                },
            ]

            return top5
            
        }

        function getPopulationStatistics(year, province, municipality, cause_of_death, genre, age) {

            // return Array Strings
        }
                
    </script> 
</body>
</html>